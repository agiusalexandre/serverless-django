



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>Speedrun - Serverless Django</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#speedrun" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Serverless Django" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Serverless Django
              </span>
              <span class="md-header-nav__topic">
                Speedrun
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Serverless Django" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Serverless Django
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      DjangoCon Europe 2019
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        DjangoCon Europe 2019
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Speedrun
      </label>
    
    <a href="./" title="Speedrun" class="md-nav__link md-nav__link--active">
      Speedrun
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demonstration-stack" title="Demonstration stack" class="md-nav__link">
    Demonstration stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#script-breakdown" title="Script breakdown" class="md-nav__link">
    Script breakdown
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demonstration-stack" title="Demonstration stack" class="md-nav__link">
    Demonstration stack
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#script-breakdown" title="Script breakdown" class="md-nav__link">
    Script breakdown
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="speedrun">Speedrun<a class="headerlink" href="#speedrun" title="Permanent link">&para;</a></h1>
<p>This is a breakdowm of the speedrun script used in my DjangoCon Europe 2019 talk on Serverless Django.</p>
<p>The speedrun showed a minimal setup for running a Django application as an AWS Lambda function using
Zappa for deployment.</p>
<p>It starts from nothing locally and ends up with a live application without any user interaction or
using the AWS Console beyond the prerequistites.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Python 3 local environment</li>
<li>AWS CLI client</li>
<li>AWS Account with:<ul>
<li>IAM User with Programatic access and sufficient permissions
  (<em>Administrative Access</em> is the equivalent of root)</li>
</ul>
</li>
<li>IAM User's credentials added to <code>~/.aws/credentials</code> locally</li>
<li>Optional for a Custom Domain:<ul>
<li>AWS Route 53 hosted zone for the domain or delegated subdomain</li>
<li>AWS Certificate Manager SSL certificate for the domain/subdomain
  (generated in the <code>us-east-1</code> region regardless of what region is used for Zappa)</li>
</ul>
</li>
</ul>
<h2 id="demonstration-stack">Demonstration stack<a class="headerlink" href="#demonstration-stack" title="Permanent link">&para;</a></h2>
<ul>
<li>AWS Lambda function to run a Django application</li>
<li>AWS API Gateway to delivery requests to the Lambda function</li>
<li>Wagtail Bakery as a sample Django application to demonstrate a front and backend CMS</li>
<li>S3 buckets to provided persistence for:<ul>
<li>static assets and media</li>
<li>SQLite database for Django</li>
<li>Zappa application deployment</li>
</ul>
</li>
<li>Django Storages to transfer static assets and media to S3</li>
<li>Zappa and Zappa-Django-Utils to build and deploy the Lambda function and manage the application</li>
</ul>
<h2 id="script-breakdown">Script breakdown<a class="headerlink" href="#script-breakdown" title="Permanent link">&para;</a></h2>
<p>This cuts everything back to the miminum shell commands and assumes every step runs smoothly.</p>
<p>This code is available in this
<a href="https://github.com/nealtodd/serverless-django/blob/master/samples/speedrun.sh">source script</a>.</p>
<p>In this example <code>${SITE}</code> is the name of the project being created and also used to name
related things like S3 buckets. In my talk this was <code>speedrun-live</code>.</p>
<p>The deployment is made to the AWS London region (<code>eu-west-1</code>).</p>
<p>Name it what you want (although the S3 bucket names that will be created must be globally unique):</p>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">SITE</span><span class="o">=</span>mysite
</pre></div>


<p>If you happen to read this before my talk an example is at this "Here's One I Made Earlier" site:
<a href="https://speedrun-hoime.bygge.net">speedrun-hoime.bygge.net</a>.</p>
<p>Create a project directory:</p>
<div class="codehilite"><pre><span></span>mkdir <span class="si">${</span><span class="nv">SITE</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>
</pre></div>


<p>Zappa needs a virtualenv to operate in:</p>
<div class="codehilite"><pre><span></span>python3 -m venv ~/.venvs/<span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>-env
<span class="nb">source</span> ~/.venvs/<span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>-env/bin/activate
pip install --upgrade pip
</pre></div>


<p>Install our support packages:</p>
<div class="codehilite"><pre><span></span>pip install zappa zappa-django-utils django-storages
</pre></div>


<p>Install our sample Django application, in this case Wagtail's <a href="https://github.com/wagtail/bakerydemo">Bakery Demo</a>:</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/wagtail/bakerydemo.git
<span class="nb">cd</span> bakerydemo
pip install -r requirements/base.txt
</pre></div>


<p>(you could instead use your own Django application or simply a fresh Django install but you'll need to tweak
the Django configuration as appropriate).</p>
<p>We're going to use the Bakey Demo's development settings with some tweaking:</p>
<div class="codehilite"><pre><span></span>cat <span class="s">&lt;&lt; EOF &gt;&gt; bakerydemo/settings/dev.py</span>
<span class="s">DATABASES = {</span>
<span class="s">    &#39;default&#39;: {</span>
<span class="s">        &#39;ENGINE&#39;: &#39;zappa_django_utils.db.backends.s3sqlite&#39;,</span>
<span class="s">        &#39;NAME&#39;: &#39;${SITE}-sqlite.db&#39;,</span>
<span class="s">        &#39;BUCKET&#39;: &#39;${SITE}-db&#39;</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">ALLOWED_HOSTS = [&#39;.eu-west-2.amazonaws.com&#39;, &#39;.bygge.net&#39;]</span>

<span class="s">AWS_STORAGE_BUCKET_NAME = &#39;${SITE}-static&#39;</span>
<span class="s">INSTALLED_APPS += (&#39;storages&#39;,)</span>
<span class="s">STATICFILES_STORAGE = &#39;storages.backends.s3boto3.S3Boto3Storage&#39;</span>
<span class="s">DEFAULT_FILE_STORAGE = &#39;storages.backends.s3boto3.S3Boto3Storage&#39;</span>

<span class="s">DEBUG = os.getenv(&#39;DJANGO_DEBUG&#39;, &#39;off&#39;) == &#39;on&#39;</span>
<span class="s">EOF</span>
</pre></div>


<div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>Use a SQLite database hosted in a S3 bucket via the <code>zappa_django_utils.db.backends.s3sqlite</code> backend</li>
<li><code>ALLOWED_HOSTS</code> covers the domain that AWS creates for the Lamdba function and also the custom domain
that will be configured with Zappa.</li>
<li>Django Storages is added and configured to send static assets and media to an S3 bucket that will be
created</li>
</ul>
</div>
<p>We're creating a Zappa settings file directly with the configuration we want rather than use <code>zappa init</code>
to create one:</p>
<div class="codehilite"><pre><span></span>cat <span class="s">&lt;&lt; EOF &gt; zappa_settings.json</span>
<span class="s">{</span>
<span class="s">    &quot;dev&quot;: {</span>
<span class="s">        &quot;django_settings&quot;: &quot;bakerydemo.settings.dev&quot;,</span>
<span class="s">        &quot;profile_name&quot;: &quot;zappa&quot;,</span>
<span class="s">        &quot;project_name&quot;: &quot;${SITE}&quot;,</span>
<span class="s">        &quot;runtime&quot;: &quot;python3.6&quot;,</span>
<span class="s">        &quot;s3_bucket&quot;: &quot;${SITE}-zappa&quot;,</span>
<span class="s">        &quot;aws_region&quot;: &quot;eu-west-2&quot;,</span>
<span class="s">        &quot;timeout_seconds&quot;: 60,</span>
<span class="s">        &quot;domain&quot;: &quot;${SITE}.bygge.net&quot;,</span>
<span class="s">        &quot;certificate_arn&quot;: &quot;${CERT_ARN}&quot;,</span>
<span class="s">        &quot;aws_environment_variables&quot;: {</span>
<span class="s">            &quot;DEBUG&quot;: &quot;off&quot;</span>
<span class="s">        }</span>
<span class="s">    }</span>
<span class="s">}</span>
<span class="s">EOF</span>
</pre></div>


<div class="admonition notes">
<p class="admonition-title">Notes</p>
<ul>
<li>This configures Zappa minimal settings in order to deploy. See the
<a href="https://github.com/Miserlou/Zappa">Zappa project</a> for full details of the settings.</li>
<li><code>timeout_seconds</code> is increased from the default of 30s to allow comfortable time for the
initial sync of the Bakery Demo's static assets to the S3 bucket</li>
<li>The <code>domain</code> and <code>certificate_arn</code> settings are for the custom domain. These can be left out
if not using a custom domain. The <code>${CERT_ARN}</code> comes from AWS Certificate Manager and is the ARN
(Amazon Resource Name) of the SSL certificate generated for the domain in the prerequisites.</li>
<li><code>aws_environment_variables</code> is an example of setting an environment variable and having it
accessible in the AWS Lambda console. Here, it allows Django's <code>DEBUG</code> mode to be toggled.</li>
</ul>
</div>
<p>In order to store the SQLite database and the static assets &amp; media we create two S3 buckets. Zappa
will create its own bucket to store the packaged application on deployment (based on the <code>s3_bucket</code>
in Zappa settings. We make the static bucket publicly accessible and apply a permissive CORs policy:</p>
<div class="codehilite"><pre><span></span>aws s3api create-bucket --bucket <span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>-db --profile zappa <span class="se">\</span>
    --region eu-west-2 --create-bucket-configuration <span class="nv">LocationConstraint</span><span class="o">=</span>eu-west-2
aws s3api create-bucket --bucket <span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>-static --profile zappa <span class="se">\</span>
    --region eu-west-2 --create-bucket-configuration <span class="nv">LocationConstraint</span><span class="o">=</span>eu-west-2
aws s3api put-bucket-cors --bucket <span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>-static --profile zappa --cors-configuration <span class="se">\</span>
    <span class="s1">&#39;{&quot;CORSRules&quot;: [{&quot;AllowedOrigins&quot;: [&quot;*&quot;], &quot;AllowedMethods&quot;: [&quot;GET&quot;]}]}&#39;</span>
aws s3api put-bucket-policy --bucket <span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>-static --profile zappa --policy <span class="se">\</span>
    <span class="s1">&#39;{&quot;Statement&quot;: [{&quot;Effect&quot;: &quot;Allow&quot;,&quot;Principal&quot;: &quot;*&quot;,&quot;Action&quot;: &quot;s3:GetObject&quot;,&quot;Resource&quot;: &quot;arn:aws:s3:::&#39;</span><span class="si">${</span><span class="nv">SITE</span><span class="si">}</span><span class="s1">&#39;-static/*&quot;}]}&#39;</span>
</pre></div>


<p>The Wagtail Bakery Demo comes with sample content, including images so we sync them to the static bucket
(where media is also stored). This is specific to the Wagtail Bakery Demo:</p>
<div class="codehilite"><pre><span></span>aws s3 sync bakerydemo/media/original_images/ s3://<span class="si">${</span><span class="nv">SITE</span><span class="si">}</span>-static/original_images/ --profile zappa
</pre></div>


<p>Okay, that's the configuration out of the way, time to use Zappa to deploy the application as a Lambda function:</p>
<div class="codehilite"><pre><span></span>zappa deploy dev
</pre></div>


<p>The <code>deploy</code> command is used to create the Lambda function and its dependencies. Once they are created it is not used again
for the environment (in this case, <code>dev</code>) - instead the <code>update</code> command is used for subsequent deployments. Zappa will create
a package for the virtual environment and local codebase and upload it to its S3 bucket before transferring it into the Lambda
function.</p>
<p>At the end of the deployment Zappa makes a request to the Lambda function to check it. In this case it'll get a server error
(<code>500</code> response). This isn't because it failed but because the Wagtail Bakery Demo isn't yet in a runnable state - the database
hasn't been migrated so no tables yet exist in the SQLite database. We'll fix that sortly.</p>
<p>As we are using a custom domain we can get Zappa to certify it so that the site runs under HTTPS on the domain. Zappa takes
care of creating an API Gateway endpoint for the custom domain using the configured certificate and a CNAME record in Route 53 to
the Lambda function's AWS domain:</p>
<div class="codehilite"><pre><span></span>zappa certify dev -y
</pre></div>


<p>Now we collect the static assets for the Wagtail Bakery Demo as we would do with a Django project. Because Lambda functions do not
have shell access we use Zappa's <code>manage</code> command to run the normal Django <code>collectstatic</code> management command (with Django Storages
handling the upload to the S3 bucket):</p>
<div class="codehilite"><pre><span></span>zappa manage dev <span class="s2">&quot;collectstatic --noinput&quot;</span>
</pre></div>


<p>Now lets use further Django management commands to migrate the database and load sample content into the Wagtail Bakery Demo:</p>
<div class="codehilite"><pre><span></span>zappa manage dev migrate
zappa manage dev load_initial_data
</pre></div>


<p>We can get the status of the deployment which will include the AWS Gateway URL and custom domain URL for the site:</p>
<div class="codehilite"><pre><span></span>zappa status dev
</pre></div>


<p>Visiting the custom domain URL (or the AWS Gateway URL if a custom domain wasn't used) shows us our serverless
Wagtail Bakery Demo site.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Page request might feel slighlty sluggish but this isn't an effect of them being serverless but rather because
we're running off a SQLite database in an S3 bucket and Zappa syncs it with a local copy within the Lambda function
on every page request. This is fine for experimentation but proper performance we can use an RDS database instead,
but that's another topic.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Subsequent deployments of the site are made with <code>zappa update dev</code></p>
</div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href=".." title="Home" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Home
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>